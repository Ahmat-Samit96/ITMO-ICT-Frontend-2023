<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Portfolio</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/my_portfolio.css">
</head>
<body>
<header class="d-flex justify-content-center py-3">
    <ul class="nav nav-pills">
        <li class="nav-item">
            <a href="index.html" class="nav-link pt-1"><img class="nav-logo " src="assets/Coinbase-logo-1.svg"
                                                            alt="coinbase logo">
            </a>
        </li>
        <li class="nav-item"><a href="search.html" class="nav-link">Поиск</a></li>
        <li class="nav-item"><a href="#" class="nav-link">Мой портфель</a></li>
        <li class="nav-item"><a href="chart.html" class="nav-link">Графики</a></li>
        <li class="nav-item"><a href="sign_in.html" class="nav-link">Вход</a></li>
        <li class="nav-item"><a href="sign_up.html" class="nav-link">Регистрация</a></li>
    </ul>
</header>
<section class="container">
    <div class="dataTable-wrapper d-flex justify-content-center">
        <table class="table align-middle border-light mt-5 w-75">
            <thead>
            <tr class="head-row border-light fw-normal">
                <th>Название</th>
                <th>Цена</th>
                <th>Количество</th>
                <th>Итого</th>
                <th class="fw-normal">
                    <div class="pagination justify-content-between" style="width: 200px">
                        <button class="btn-pagination btn-prev" onclick="prev_page()"><img style="width: 15px;"
                                                                                           src="assets/left-arrow-svgrepo-com.svg"
                                                                                           alt="">
                        </button>
                        <button class="btn-pagination btn-next" onclick="next_page()"><img
                            style="width: 15px; transform: rotate(180deg)" src="assets/left-arrow-svgrepo-com.svg"
                            alt="">
                        </button>
                    </div>
                </th>
            </tr>
            </thead>
            <tbody class="coin-wrapper">

            </tbody>
        </table>
    </div>
</section>
<script>
    function checkAuth() {
        if (!localStorage.user) {
            window.location.href = 'http://localhost:63342/ITMO-ICT-Frontend-2022/labs/K33402/Konev_Anton/Lab_2/sign_in.html'
        } else {
            loadCoins()
        }
    }

    function getCoinHtml({image, name, current_price, symbol}, amount) {
        return `
            <tr class="">
                <td>
                    <div class="d-flex align-items-center logo-item p-0">
                        <img src="${image}" alt="" style="width: 30px; height: 30px"
                             class="rounded-circle"/>
                        <div class="ms-2">
                            <p class="fw-bold mb-0">${name}</p>
                            <p class="text-muted mb-0">${symbol.toUpperCase()}</p>
                        </div>
                    </div>
                </td>
                <td>
                    <p class="fw-normal mb-0">RUB ${current_price}</p>
                </td>
                <td class="amount">
                    ${amount}
                </td>
                <td>
                    <span class="total">
                    RUB ${amount * current_price}
                    </span>
                </td>
                <td class="d-flex justify-content-between">
                    <button type="button" class="btn btn-primary btn-link rounded-pill text-white text-decoration-none" value="${symbol}" onclick="">
                        Купить
                    </button>
                    <button type="button" class="btn btn-danger btn-link rounded-pill text-white text-decoration-none" value="${symbol}" onclick="">
                        Продать
                    </button>
                </td>
            </tr>
        `
    }

    const url = 'http://localhost:3000/currency'
    let data, currCoins;
    let currentPage = 1;
    let coinsPerPage = 2;
    let amount = [];

    const btnPrev = document.querySelector('.btn-prev')
    const btnNext = document.querySelector('.btn-next')

    function prev_page() {
        if (currentPage > 1) {
            currentPage--;
            loadCoins()
        }
    }

    function next_page() {
        if (currentPage < Math.ceil(currCoins / coinsPerPage)) {
            currentPage++;
            loadCoins()
        }

    }

    async function loadCoins() {
        document.querySelector('.coin-wrapper').innerHTML = "";

        let currentUser = JSON.parse(localStorage.getItem('user'));

        const user = await fetch(`http://localhost:3000/users?id=${currentUser[0].id}`);
        const userJson = await user.json();

        const {coins} = userJson[0];

        const response = await fetch(url);

        data = await response.json();
        currCoins = coins.length;


        btnPrev.style.visibility = currentPage === 1 ? "hidden" : "visible"
        btnNext.style.visibility = currentPage === Math.ceil(currCoins / coinsPerPage) ? "hidden" : "visible"

        let renderQuery = [];

        if (coins.length !== null) {
            for (let i = 0; i < data.length; i++) {
                for (let j = 0; j < currCoins; j++) {
                    if (coins[j].id === data[i].id) {
                        amount.push(coins[j].amount);
                        renderQuery.push(data[i])
                    }
                }
            }
        }

        if (coins.length !== null) {
            for (let k = (currentPage - 1) * coinsPerPage; k < (currentPage * coinsPerPage); k++) {
                if (k > currCoins - 1) {
                    break
                }

                if (currCoins < coinsPerPage) {
                    btnPrev.style.visibility = "hidden"
                    btnNext.style.visibility = "hidden"
                }

                document.querySelector('.coin-wrapper').innerHTML += getCoinHtml(renderQuery[k], amount[k])

            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => checkAuth())
</script>
</body>
</html>
